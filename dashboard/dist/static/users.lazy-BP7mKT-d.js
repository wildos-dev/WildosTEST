import{r as j,j as e}from"./react-core-Bcdk_OeX.js";import{u as g,n as N,P as U,o as I,j as h,p as b,I as u,q as P,D as E,r as A,s as L,t as $,v as K,w as M,x as B,y as H,z as V,T as R,A as Q,E as G,F as m,G as y,H as v,J as C,K as _,L as w,M as T,N as J,O as k,R as X,V as Z,X as q,Y,U as W,Z as ee,B as se,$ as te,a0 as ae,a1 as ne}from"./index-DRsjEK3q.js";import"./layout-Y81SaLgb.js";import{d as x,aJ as l}from"./react-ecosystem-6S3Qhx2r.js";import"./dnd-kit-BufO2FBr.js";import{u as re,L as ie,h as le,O as oe}from"./router-DsiC1lhN.js";import{P as ce}from"./index-BIixQq-_.js";import{E as de}from"./entity-table-DPjPnjre.js";import{N as me,D as O}from"./index-12oAgeI5.js";import"./monaco-D6sUsa5W.js";import"./styling-utils--BulIq_u.js";import"./network-3TAtD9nM.js";import"./query-BGTG4bZD.js";import"./state-BNTuQEE6.js";import"./forms-BplYsbWl.js";import"./search-BP5e7l94.js";import"./date-utils-hmeNWewA.js";import"./table-DQ5QIWK1.js";import"./recharts-D-jZI7XS.js";function ue({title:t,column:s,options:a}){const[r,n]=j.useState(!1),c=g("md"),[i,d]=j.useState(null),{filters:p,table:{setPageIndex:o}}=N();function D(){p.setColumnsFilter({...p.columnsFilter,[s.id]:void 0}),d(null),o(1)}return c?e.jsxs(U,{open:r,onOpenChange:n,children:[e.jsx(I,{asChild:!0,children:e.jsxs(h,{variant:"ghost",size:"sm",className:"data-[state=open]:bg-accent justify-start",children:[i||t,e.jsx(h,{variant:"ghost",onMouseDown:D,size:"sm",className:b("p-2 ml-1",{"hover:text-destructive/90":!!i,"hover:text-primary/90":!i}),children:i?e.jsx(u,{name:"FilterX",className:"size-4"}):e.jsx(u,{name:"Filter",className:"size-4"})})]})}),e.jsx(P,{className:"w-[200px] p-0",align:"start",children:e.jsx(f,{setOpen:n,columnName:s.id,setSelectedOption:z=>{d(z),o(1)},options:a})})]}):e.jsxs(E,{open:r,onOpenChange:n,children:[e.jsx(A,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"sm",className:"data-[state=open]:bg-accent w-fit justify-start",children:i||t})}),e.jsx(L,{children:e.jsx("div",{className:"mt-4 border-t",children:e.jsx(f,{setOpen:n,columnName:s.id,setSelectedOption:d,options:a})})})]})}function f({setOpen:t,setSelectedOption:s,options:a,columnName:r}){const{filters:n}=N(),{t:c}=x();return e.jsxs($,{children:[e.jsx(K,{className:"border-0 focus:ring-0",placeholder:c("placeholders.filter-options")}),e.jsxs(M,{children:[e.jsx(B,{children:c("table.no-result-found")}),e.jsx(H,{children:a.map(i=>e.jsx(V,{value:i,onSelect:d=>{s(d),t(!1),n.setColumnsFilter({...n.columnsFilter,[r]:d})},children:i},i))})]})]})}const S=({user:t})=>{let s,a;const r=ge(t),{t:n}=x();return t.online_at===null?(s="text-yellow-500",a=n("not_connected")):r?(s="text-green-500",a=n("online")):(s="text-red-500",a=n("offline")),e.jsxs(R,{children:[e.jsx(Q,{children:e.jsx(u,{name:"Circle",className:b("w-5 h-5",s)})}),e.jsx(G,{children:a})]})},xe=t=>[{accessorKey:"username",header:({column:s})=>e.jsx(m,{title:l.t("username"),column:s}),cell:({row:s})=>{const a=s.original;return a?e.jsxs("div",{className:"flex flex-row gap-2 items-center",children:[e.jsx(S,{user:a})," ",a.username||l.t("unknown")]}):null}},{accessorKey:"activated",enableSorting:!1,header:({column:s})=>e.jsx(m,{title:l.t("activated"),column:s}),cell:({row:s})=>{const a=s.original;return a?e.jsx(y,{user:a}):null}},{accessorKey:"owner_username",enableSorting:!1,sudoVisibleOnly:!0,header:({column:s})=>e.jsx(pe,{column:s}),meta:{className:"hidden lg:table-cell"}},{accessorKey:"used_traffic",header:({column:s})=>e.jsx(m,{title:l.t("page.users.used_traffic"),column:s,className:"hidden sm:table-cell"}),cell:({row:s})=>{const a=s.original;return a?e.jsx("div",{className:"hidden sm:table-cell",children:e.jsx(v,{user:a})}):null},meta:{className:"hidden sm:table-cell"}},{accessorKey:"expire_strategy",header:({column:s})=>e.jsx(m,{title:l.t("page.users.expire_method"),column:s,className:"hidden md:table-cell"}),cell:({row:s})=>{const a=s.original;return a?e.jsx("div",{className:"hidden md:table-cell",children:e.jsx(F,{user:a})}):null},enableSorting:!1,meta:{className:"hidden md:table-cell"}},{accessorKey:"expire_date",header:({column:s})=>e.jsx(m,{title:l.t("page.users.expire_date"),column:s,className:"hidden md:table-cell"}),cell:({row:s})=>{const a=s.original;return a?e.jsx("div",{className:"hidden md:table-cell",children:e.jsx(C,{user:a})}):null},meta:{className:"hidden md:table-cell"}},{id:"actions",header:()=>e.jsx("span",{className:"sr-only",children:l.t("actions")}),cell:({row:s})=>{const a=s.original;if(!a)return null;const r=!g("md");return e.jsx(me,{row:s,actions:t,children:e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx(_,{text:T(a.subscription_url||""),successMessage:l.t("page.users.settings.subscription_link.copied"),copyIcon:n=>e.jsx(u,{name:"Link",...n}),className:w({variant:"secondary",size:r?"touch-sm":"sm",className:r?"size-10":"size-8"}),tooltipMsg:l.t("page.users.settings.subscription_link.copy"),"data-testid":`button-copy-link-${a.username}`}),e.jsx(O,{...t,row:s})]})})}}];function pe({column:t}){const{data:s}=J({page:1,size:100,filters:{}});return e.jsx(ue,{title:l.t("owner"),column:t,options:s?.entities?.map(a=>a?.username).filter(Boolean)||[]})}const he=({entity:t,actions:s,onRowClick:a})=>{const{isSudo:r}=k(),n=()=>{a?.(t)},c=i=>{i.stopPropagation()};return e.jsxs(X,{className:"w-full cursor-pointer hover:bg-muted/50 transition-colors",onClick:n,"data-testid":`card-user-${t.username}`,children:[e.jsx(Z,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-row gap-2 items-center min-w-0 flex-1",children:[e.jsx(S,{user:t}),e.jsx("span",{className:"font-medium truncate","data-testid":`text-username-${t.username}`,children:t.username||l.t("unknown")})]}),e.jsx(y,{user:t})]})}),e.jsxs(q,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:l.t("page.users.used_traffic")}),e.jsx(v,{user:t})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:l.t("page.users.expire_method")}),e.jsx(F,{user:t})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:l.t("page.users.expire_date")}),e.jsx(C,{user:t})]})]}),r()&&t.owner_username&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:l.t("owner")}),e.jsx("div",{className:"text-sm","data-testid":`text-owner-${t.username}`,children:t.owner_username})]})]}),e.jsx(Y,{className:"pt-2",onClick:c,children:e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx(_,{text:T(t.subscription_url||""),successMessage:l.t("page.users.settings.subscription_link.copied"),copyIcon:i=>e.jsx(u,{name:"Link",...i}),className:w({variant:"secondary",size:"touch-sm",className:"size-11 min-w-11"}),tooltipMsg:l.t("page.users.settings.subscription_link.copy"),"data-testid":`button-copy-link-${t.username}`}),e.jsx("div",{className:"flex-1",children:e.jsx(O,{...s,row:{original:t},className:"w-full justify-end"})})]})})]})},je=()=>{const t=re({from:"/users"}),{isSudo:s}=k(),a=o=>{t({to:"/users/$userId",params:{userId:o.username}})},r=o=>{t({to:"/users/$userId/edit",params:{userId:o.username}})},n=o=>{t({to:"/users/$userId/delete",params:{userId:o.username}})},c=xe({onEdit:r,onDelete:n,onOpen:a}),i=c.filter(o=>!o.sudoVisibleOnly),d=s()?c:i,p={onEdit:r,onDelete:n,onOpen:a};return e.jsx(de,{fetchEntity:ee,columns:d,primaryFilter:"username",entityKey:W,onCreate:()=>t({to:"/users/create"}),onOpen:a,CardComponent:he,cardActions:p})},F=({user:t})=>{const{t:s}=x(),a={start_on_first_use:s("page.users.on_first_use"),fixed_date:s("page.users.fixed_date"),never:s("page.users.never")}[t.expire_strategy],r={start_on_first_use:"royal",fixed_date:"warning",never:"disabled"}[t.expire_strategy];return e.jsx(se,{variant:r,children:a})},fe=()=>{const{t}=x(),{data:s}=te({page:1,size:10});return s&&s.pageCount===0&&e.jsx(ae,{title:t("page.users.services-alert.title"),desc:e.jsxs(e.Fragment,{children:[t("page.users.services-alert.desc"),e.jsx(ie,{className:"m-1 font-semibold text-secondary-foreground",to:"/services",children:t("page.nodes.certificate-alert.click")})]})})},ge=t=>{const s=new Date(t.online_at+"Z");return Math.abs(new Date().getTime()-s.getTime())<3e4},Ne=()=>{const{t}=x();return e.jsxs(ce,{title:t("users"),footer:e.jsx(fe,{}),children:[e.jsx(je,{}),e.jsx(j.Suspense,{fallback:e.jsx(ne,{}),children:e.jsx(oe,{})})]})},$e=le("/_dashboard/users")({component:()=>e.jsx(Ne,{})});export{$e as Route,Ne as UsersPage};
