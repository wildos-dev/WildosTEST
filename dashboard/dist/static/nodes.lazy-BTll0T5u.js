import{r as o,j as e}from"./react-core-Bcdk_OeX.js";import{b2 as V,b3 as A,b4 as G,b5 as Z,ap as H,p as Q,j as v,I as d,aq as X,b6 as h,b7 as K,B,g as U,Z as T,a5 as Y,a6 as J,a7 as W,a8 as ee,a9 as se,aa as R,b8 as te}from"./index-D9xJNTt9.js";import"./layout-Y81SaLgb.js";import{d as L}from"./react-ecosystem-DA9e0y3F.js";import"./dnd-kit-BufO2FBr.js";import{u as ae,e as ne,h as re,O as ie}from"./router-BzWBhOx2.js";import{P as le}from"./index-d4rf_bwY.js";import{a as oe}from"./search-CgVhiaN-.js";import{b as ce}from"./query-BGTG4bZD.js";import{o as M,G as F}from"./date-utils-hmeNWewA.js";import{S as de}from"./index-BqxW2es5.js";import"./monaco-D6sUsa5W.js";import"./styling-utils--BulIq_u.js";import"./network-3TAtD9nM.js";import"./forms-D7oth6Cp.js";import"./state-BNTuQEE6.js";import"./table-DQ5QIWK1.js";import"./recharts-CPh6Hnhc.js";function me(s={}){const{threshold:x=0,root:r=null,rootMargin:N="0%",freezeOnceVisible:c=!1}=s,[t,g]=o.useState(),m=o.useRef(null),w=t?.isIntersecting&&c;o.useEffect(()=>{const i=m?.current;if(!!!window.IntersectionObserver||w||!i)return;const S={threshold:x,root:r,rootMargin:N},u=new IntersectionObserver(([_])=>g(_),S);return u.observe(i),()=>u.disconnect()},[x,r,N,w]);const p=o.useRef(),f=o.useRef();return o.useEffect(()=>{!t||!t.boundingClientRect||(p.current!==void 0&&f.current!==void 0&&(t.boundingClientRect.y<p.current&&t.intersectionRatio<f.current?g(i=>i&&{...i,isScrollingDown:!0}):g(i=>i&&{...i,isScrollingDown:!1})),p.current=t.boundingClientRect.y,f.current=t.intersectionRatio)},[t]),{elementRef:m,isIntersecting:t?.isIntersecting??!1,entry:t}}const ue=s=>{switch(s){case h.healthy.label:return"from-emerald-400 to-teal-600";case h.unhealthy.label:return"from-red-400 to-pink-600";case h.disabled.label:return"from-gray-400 to-slate-600";default:return"from-blue-400 to-indigo-600"}},he=({node:s,onEdit:x,onDelete:r,onClick:N,className:c})=>{const{t}=L(),[g]=o.useState("1d"),{start:m,end:w}=V(g),{data:p,isLoading:f}=A({nodeId:s.id,start:m,end:w}),{elementRef:i,isIntersecting:k}=me({threshold:.1,rootMargin:"50px"}),S=o.useMemo(()=>(s.id*1234567%4e3-2e3)/1e3,[s.id]),u=G(s,k,S),_=o.useMemo(()=>u.data?Object.values(u.data).filter(n=>n?.running===!0).length:0,[u.data]),y=p?.total??0,[C,$]=Z(y),O=ue(s.status||"default"),q=n=>{n.stopPropagation(),N(s)},P=n=>{n.stopPropagation(),x(s)},z=n=>{n.stopPropagation(),r(s)};return e.jsxs(H,{ref:i,className:Q("relative overflow-hidden cursor-pointer hover:shadow-lg transition-all duration-300 group",c),onClick:q,children:[e.jsx("div",{className:Q("absolute inset-0 bg-gradient-to-br opacity-10 group-hover:opacity-15 transition-opacity",O)}),e.jsxs("div",{className:"absolute top-2 right-2 sm:top-3 sm:right-3 flex gap-1 sm:gap-2 opacity-100 sm:opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity z-20",children:[e.jsx(v,{variant:"secondary",size:"touch-sm",onClick:P,className:"focus-visible:opacity-100 shadow-lg",title:t("page.nodes.edit_node"),children:e.jsx(d,{name:"Edit",className:"h-4 w-4 sm:h-5 sm:w-5"})}),e.jsx(v,{variant:"destructive",size:"touch-sm",onClick:z,className:"focus-visible:opacity-100 shadow-lg",title:t("page.nodes.delete_node"),children:e.jsx(d,{name:"Trash2",className:"h-4 w-4 sm:h-5 sm:w-5"})})]}),e.jsxs(X,{className:"relative p-4 sm:p-6",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-foreground mb-2 truncate pr-24 sm:pr-20",children:s.name}),s.status&&h[s.status]&&e.jsx(K,{status:h[s.status]})]})}),e.jsx("div",{className:"absolute top-2 left-2 sm:top-3 sm:left-3 z-10",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground bg-background/80 backdrop-blur-sm rounded px-2 py-1",children:[e.jsx(d,{name:"Hash",className:"h-3 w-3"}),e.jsxs("span",{className:"hidden sm:inline",children:[t("id"),": "]}),e.jsx("span",{className:"sm:hidden",children:"#"}),e.jsx("span",{children:s.id})]})}),e.jsxs("div",{className:"space-y-2 sm:space-y-3 mb-4 sm:mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(d,{name:"Globe",className:"h-4 w-4 shrink-0"}),e.jsxs("span",{className:"truncate",children:[s.address,":",s.port]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(d,{name:"Server",className:"h-4 w-4"}),e.jsxs("span",{children:[t("page.nodes.usage_coefficient"),": ",s.usage_coefficient]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(d,{name:"Zap",className:"h-4 w-4"}),e.jsxs("span",{children:[t("page.nodes.backend"),": ",(()=>{const n=[];n.push(s.xray_version?`Xray ${s.xray_version}`:"Xray");const D=s.backends.find(l=>l.backend_type==="singbox"||l.name.toLowerCase().includes("singbox")||l.name.toLowerCase().includes("sing-box"));D&&n.push(`SingBox ${D.version||""}`);const b=s.backends.find(l=>l.backend_type==="hysteria"||l.backend_type==="hysteria2"||l.name.toLowerCase().includes("hysteria"));return b&&n.push(`Hysteria ${b.version||""}`),n.join(", ")})()]})]}),s.backends.length>0&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(d,{name:"Zap",className:"h-4 w-4"}),e.jsxs("span",{children:[_,"/",s.backends.length," ",t("page.nodes.backends_running")]})]}),s.cert_created_at&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(d,{name:"Shield",className:"h-4 w-4"}),e.jsxs("span",{children:[t("page.nodes.cert_issued"),": ",F(new Date(s.cert_created_at))?M(new Date(s.cert_created_at),"P"):t("invalid_date")]})]}),s.cert_expires_at&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(d,{name:"Shield",className:"h-4 w-4"}),e.jsxs("span",{children:[t("page.nodes.cert_expires"),": ",F(new Date(s.cert_expires_at))?M(new Date(s.cert_expires_at),"P"):t("invalid_date")]})]})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:t("page.nodes.traffic_usage")}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-lg font-semibold text-foreground",children:f?"...":`${C} ${$}`}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t("total")})]})]})}),s.backends.length>0&&e.jsx("div",{className:"border-t pt-3 sm:pt-4 mt-3 sm:mt-4",children:e.jsxs("div",{className:"flex flex-wrap gap-1 sm:gap-2",children:[s.backends.slice(0,3).map(n=>{const b=u.data?.[n.name]?.running===!0,l=u.isLoading;return e.jsxs(B,{variant:l?"outline":b?"default":"outline",className:"text-xs",title:`${t("type")}: ${n.backend_type}, ${t("version")}: ${n.version}, ${t("status")}: ${t(l?"loading":b?"running":"down")}`,children:[n.name,b&&e.jsx("div",{className:"ml-1 w-2 h-2 bg-green-500 rounded-full"})]},n.name)}),s.backends.length>3&&e.jsxs(B,{variant:"outline",className:"text-xs",children:["+",s.backends.length-3," ",t("more")]})]})})]})]})},xe=()=>{const{t:s}=L(),x=ae(),r=ne({from:"/_dashboard/nodes"}),N=ce(),c=r.q??"",t=r.status,g=r.showDisabled,m=r.page,w=12,[p,f]=o.useState(c),[i]=oe(p,350);o.useEffect(()=>{i!==c&&C({q:i,page:void 0})},[i]),o.useEffect(()=>{f(c)},[c]);const{data:k,isLoading:S,error:u}=U({page:m,size:w,filters:{...c&&{name:c},...t!=="all"&&{status:t},...g&&{showDisabled:"true"}}}),_=k?.entities||[],y=k?.pageCount||0,C=a=>{const j={q:a.hasOwnProperty("q")?a.q:r.q,status:a.hasOwnProperty("status")?a.status??"all":r.status,page:a.hasOwnProperty("page")?a.page??1:r.page,showDisabled:a.hasOwnProperty("showDisabled")?a.showDisabled??!1:r.showDisabled},I={};j.q&&(I.q=j.q),j.status!=="all"&&(I.status=j.status),j.page!==1&&(I.page=j.page),j.showDisabled!==!1&&(I.showDisabled=j.showDisabled),x({to:"/nodes",search:I,replace:!0})},$=a=>{f(a)},O=()=>{N.invalidateQueries({queryKey:["nodes"],exact:!1})},q=a=>{C({status:a,page:void 0})},P=a=>{C({page:a})},z=a=>{C({showDisabled:a,page:void 0})},n=a=>{x({to:"/nodes/$nodeId",params:{nodeId:String(a.id)},search:r})},D=a=>{x({to:"/nodes/$nodeId/edit",params:{nodeId:String(a.id)},search:r})},b=a=>{x({to:"/nodes/$nodeId/delete",params:{nodeId:String(a.id)},search:r})},l=()=>{x({to:"/nodes/create",search:r})},E=_;return S?e.jsx(T,{}):u?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-destructive text-lg mb-2",children:"Error loading nodes"}),e.jsx("div",{className:"text-muted-foreground mb-4",children:u.message||"Failed to fetch nodes data"}),e.jsx(v,{onClick:O,variant:"outline","data-testid":"button-retry-nodes",children:"Try again"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 items-stretch lg:items-center",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 flex-1 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 max-w-full sm:max-w-md",children:[e.jsx(d,{name:"Search",className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Y,{placeholder:s("placeholders.search-filter"),value:p,onChange:a=>$(a.target.value),className:"pl-10 w-full","data-testid":"input-search-nodes"})]}),e.jsxs(J,{value:t,onValueChange:q,children:[e.jsx(W,{className:"w-full sm:w-48","data-testid":"select-status-filter",children:e.jsx(ee,{placeholder:s("status")})}),e.jsxs(se,{children:[e.jsx(R,{value:"all","data-testid":"select-option-all",children:"All"}),e.jsx(R,{value:h.healthy.label,"data-testid":"select-option-healthy",children:e.jsx("span",{className:"capitalize",children:h.healthy.label})}),e.jsx(R,{value:h.unhealthy.label,"data-testid":"select-option-unhealthy",children:e.jsx("span",{className:"capitalize",children:h.unhealthy.label})}),e.jsx(R,{value:h.disabled.label,"data-testid":"select-option-disabled",children:e.jsx("span",{className:"capitalize",children:h.disabled.label})})]})]})]}),e.jsxs(v,{onClick:l,className:"w-full lg:w-auto shrink-0","data-testid":"button-create-node",children:[e.jsx(d,{name:"Plus",className:"h-4 w-4 mr-2"}),s("create")]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(te,{id:"showDisabled",checked:g,onCheckedChange:z,"data-testid":"checkbox-show-disabled"}),e.jsx("label",{htmlFor:"showDisabled",className:"text-sm font-medium cursor-pointer",children:"Show disabled nodes"})]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground","data-testid":"text-nodes-count",children:[s("found")," ",E.length," ",s("nodes")]}),E.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-muted-foreground text-lg mb-2",children:s(c||t!=="all"||g?"table.no-result-found":"no-nodes-available")}),!c&&t==="all"&&!g&&e.jsxs(v,{onClick:l,variant:"outline","data-testid":"button-create-first-node",children:[e.jsx(d,{name:"Plus",className:"h-4 w-4 mr-2"}),s("create-first-node")]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6","data-testid":"grid-nodes",children:E.map(a=>e.jsx(he,{node:a,onClick:n,onEdit:D,onDelete:b,"data-testid":`card-node-${a.id}`},a.id))}),y>1&&e.jsx("div",{className:"flex justify-center mt-8",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>P(Math.max(1,m-1)),disabled:m===1,"data-testid":"button-previous-page",children:"Previous"}),e.jsxs("span",{className:"text-sm text-muted-foreground px-4","data-testid":"text-pagination-info",children:["Page ",m," / ",y]}),e.jsx(v,{variant:"outline",onClick:()=>P(Math.min(y,m+1)),disabled:m>=y,"data-testid":"button-next-page",children:"Next"})]})})]})},ge=()=>{const{t:s}=L();return e.jsxs(le,{title:s("nodes"),className:"sm:w-screen md:w-full",children:[e.jsx(xe,{}),e.jsx(o.Suspense,{fallback:e.jsx(T,{}),children:e.jsx(ie,{})})]})},qe=re("/_dashboard/nodes")({component:()=>e.jsx(de,{children:e.jsx(ge,{})})});export{ge as NodesPage,qe as Route};
